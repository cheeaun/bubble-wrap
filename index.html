<!DOCTYPE html>
<title>Bubble wrap</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=MuseoModerno:wght@400;700&display=swap" rel="stylesheet">
<link rel="preload" href="popped.svg" as="image">
<link rel="preload" href="bubble-wrap-single-pop.mp3" as="fetch">
<style>
  * {
    font-family: 'MuseoModerno', cursive;
  }
  html, body {
    margin: 0;
    padding: 0;
    border: 0;
  }
  body {
    background-color: #E7EEEF;
    color: #000;
  }
  main {
    display: flex;
    flex-direction: column;
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    top: 0;
  }
  header {
    text-align: center;
    padding: 1em;
  }
  header * {
    margin: 0;
    padding: 0;
  }
  header h1 {
    text-transform: lowercase;
    font-size: 28px;
  }
  header p {
    font-size: .9em;
  }
  button {
    background-color: transparent;
    border: 1px solid #000;
    padding: 8px 14px;
    border-radius: 99999px;
    user-select: none;
    line-height: 1;
    vertical-align: middle;
    cursor: pointer;
  }
  button:disabled {
    color: inherit;
  }
  #bubble-wrap {
    flex-grow: 1;
    overflow: hidden;
    line-height: 0px;
    text-align: center;
    white-space: nowrap;
  }
  .bubble {
    display: inline-block;
    background: transparent no-repeat center;
    background-image:
      url(prepop.svg),
      radial-gradient(closest-side, rgba(50,50,50,.1), rgba(255,255,255,.5) 75%, rgba(255,255,255,0) 80%),
      radial-gradient(closest-side at 53% 53%, rgba(255,255,255,0) 50%, rgba(0,0,0,.1) 80%, rgba(255,255,255,0));
    width: 60px;
    height: 60px;
    overflow: hidden;
    background-size: 70%, contain, contain;
    border-radius: 99999px;
    margin-bottom: -10px;
    cursor: pointer;
  }
  .bubble:active,
  .bubble.checked {
    background-image:
      url(popped.svg),
      radial-gradient(closest-side, rgba(0,0,0,.2), rgba(255,255,255,.5) 75%, rgba(255,255,255,0) 80%),
      radial-gradient(closest-side at 53% 53%, rgba(255,255,255,0) 50%, rgba(0,0,0,.1) 80%, rgba(255,255,255,0));
  }
  .bubble.checked {
    pointer-events: none;
  }
  @keyframes fallin {
    0% {
      opacity: 0;
      transform: translateY(-10px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .bubble:nth-child(n) {
    animation: fallin .3s both ease-in-out;
  }
  .bubble:nth-child(2n) {
    animation: fallin .3s .1s both ease-in-out;
  }
  .bubble:nth-child(3n) {
    animation: fallin .3s .2s both ease-in-out;
  }
  .bubble:nth-child(4n) {
    animation: fallin .3s .3s both ease-in-out;
  }
  .bubble:nth-child(5n) {
    animation: fallin .3s .4s both ease-in-out;
  }
</style>
<main>
  <header>
    <h1>Bubble wrap <button id="pop-reset-button" disabled>pop me! ッ</button></h1>
    <p>Inspired by <a href="https://twitter.com/jchens_/status/1366402596827779075" target="_blank">jchen</a>'s work. Sound by <a href="https://freesound.org/people/Anthousai/sounds/399334/" target="_blank">anthousai</a>. Made by <a href="https://twitter.com/cheeaun" target="_blank">cheeaun</a>.</p>
  </header>
  <div id="bubble-wrap"></div>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.1/howler.min.js" integrity="sha512-L6Z/YtIPQ7eU3BProP34WGU5yIRk7tNHk7vaC2dB1Vy1atz6wl9mCkTPPZ2Rn1qPr+vY2mZ9odZLdGYuaBk7dQ==" crossorigin="anonymous"></script>
<script>
  var bubbleSize = 60;
  var $wrap = document.getElementById('bubble-wrap');
  var $resetButton = document.getElementById('pop-reset-button');

  var unpopTimers = [];
  function resetUnpop(){
    unpopTimers.forEach(function(t){ clearTimeout(t) });
    unpopTimers = [];
  };

  var total = 0;
  function render() {
    resetUnpop();
    resetResetButton();

    var bubbleColCount = Math.floor($wrap.offsetWidth/bubbleSize);
    var bubbleAltColCount = bubbleColCount-1;
    var bubbleRowCount = Math.floor($wrap.offsetHeight/bubbleSize);
    var bubbleAltRowCount = Math.floor(bubbleRowCount/2);
    var count = bubbleColCount * bubbleRowCount - bubbleAltRowCount;
    total = count;
    var html = '';
    var toggleRow = true;
    let col = 1;
    for (var i=0; i<count; i++) {
      html += '<span class="bubble"></span>';
      if ((toggleRow && col % bubbleColCount === 0) || (!toggleRow && col % bubbleAltColCount === 0)) {
        html += '<br>';
        toggleRow = !toggleRow;
        col = 0;
      }
      col++;
    }
    $wrap.innerHTML = html;
  }

  var resetButton = false;
  function resetResetButton() {
    resetButton = false;
    $resetButton.disabled = true;
    $resetButton.textContent = 'pop me! ッ';
  }

  $resetButton.onclick = function(e){
    e.preventDefault();
    render();
  }

  var sound = new Howl({
    src: ['bubble-wrap-single-pop.mp3'],
    volume: 0.5,
  });
  var startTime;
  var checkTimer;
  var playTime = 0;
  document.body.onpointerdown = function(e) {
    e.preventDefault();
    var target = e.target;
    if (target.classList.contains('bubble')) {
      if (!startTime) startTime = Date.now();
      target.classList.add('checked');
      sound.play();
      if (!resetButton) {
        resetButton = true;
        $resetButton.disabled = false;
        $resetButton.textContent = 'Reset!'
      }
      clearTimeout(checkTimer);
      checkTimer = setTimeout(function(){
        var poppedAll = $wrap.querySelectorAll('.checked').length === total;
        if (poppedAll) {
          alert("Woohoo! You've popped all " + total + " of them in just " + Math.round((Date.now() - startTime)/1000) +  "s! Do it again!");
          startTime = null;
          playTime++;
          render();
        }
      }, 600);

      unpopTimers.push(setTimeout(function(){
        var popped = $wrap.querySelectorAll('.checked');
        if (!popped.length) return;
        var randomIndex = Math.floor(Math.random() * popped.length);
        popped[randomIndex].classList.remove('checked');
      }, Math.max(1, 20 - playTime) * 1000));
    }
  }
  document.body.addEventListener('touchmove', function(e){
    e.preventDefault();
  }, { passive: false });

  render();

  var resizeTimer;
  window.onresize = function(){
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(render, 1000);
  }
</script>